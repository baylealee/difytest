- name: Call Dify Agent API for processing
  run: |
    set -x
    sudo apt-get update && sudo apt-get install -y jq

    # 检查文件是否存在
    if [ ! -f vendorex.xlsx ]; then
      echo "File vendorex.xlsx not found!"
      exit 1
    fi

    # 准备文件
    base64_file=$(base64 vendorex.xlsx | tr -d '\n')

    # 构建请求数据
    request_data=$(jq -n \
      --arg content "请处理以下文件" \
      --arg filename "vendorex.xlsx" \
      --arg file_content "$base64_file" \
      '{inputs: [{role: "user", content: $content, files: [{name: $filename, content: $file_content}]}]}')

    echo "Request Data: $request_data"

    # 调用 Dify Agent API（请替换 {agent_id}）
    response=$(curl -s -X POST "https://api.dify.ai/v1/agents/{agent_id}/chat-messages" \
      -H "Authorization: Bearer ${{ secrets.DIFY_API_TOKEN }}" \
      -H "Content-Type: application/json" \
      -d "$request_data")

    if [ $? -ne 0 ]; then
      echo "Curl command failed"
      exit 1
    fi

    echo "API Response: $response"

    # 检查响应是否包含错误
    if echo "$response" | jq -e '.error' > /dev/null; then
      echo "Received error from API: $(echo "$response" | jq '.error')"
      exit 1
    fi

    # 提取回复内容和文件
    reply_content=$(echo "$response" | jq -r '.choices[0].message.content')
    file_content=$(echo "$response" | jq -r '.choices[0].message.files[0].content')

    if [ -z "$file_content" ] || [ "$file_content" == "null" ]; then
      echo "No file content received from API"
      exit 1
    fi

    # 解码并保存文件
    echo "$file_content" | base64 -d > processed_vendorex.xlsx

    # 输出回复内容
    echo "$reply_content"
