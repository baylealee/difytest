name: Process vendorex Segmentation

on:
  push:
    paths:
      - 'vendorex.xlsx'  # 当 vendorex.xlsx 文件有变更时触发
  workflow_dispatch:  # 手动触发

jobs:
  process:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false  # 禁用自动 Git 认证

      - name: Authenticate with GitHub token
        run: |
          git config --global user.email "${{ secrets.GIT_USER_EMAIL }}"
          git config --global user.name "${{ secrets.GIT_USER_NAME }}"
          git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"

      - name: Call Dify API for processing
        run: |
          response=$(curl --fail -X POST "https://api.dify.ai/v1" \
            -H "Authorization: Bearer ${{ secrets.DIFY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
                  "file_url": "https://raw.githubusercontent.com/${{ github.repository }}/main/vendorex.xlsx",
                  "process_type": "vendor_segmentation",
                  "output_format": "csv"
                }')
          echo "$response" > processed_vendorex.csv

      - name: Commit the processed file back to GitHub
        run: |
          git add processed_vendorex.csv
          git commit -m "Processed vendorex segmentation and updated CSV"
          git push origin HEAD:main
